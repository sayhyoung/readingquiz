<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <!-- ë°˜ì‘í˜• í™”ë©´ì„ ìœ„í•œ meta íƒœê·¸ -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ğŸ”±ì˜ì–´ ë…í•´ ë¬¸ì œ ìƒì„± ë§ˆë²•ì‚¬ğŸ”±</title>
  <!-- ì•„ì´ì½˜ (Font Awesome) -->
  <link 
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
    crossorigin="anonymous"
  />
  <style>
    /* ê¸°ë³¸ ìŠ¤íƒ€ì¼ */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    body {
      font-family: 'Malgun Gothic', Arial, sans-serif;
      background-color: #f8f9fa;
      margin: 0;
      padding: 20px;
    }
    .container {
      max-width: 900px;
      margin: 0 auto;
      background: #fff;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    h1 {
      text-align: center;
      color: #007bff;
      margin-bottom: 20px;
    }
    .tabs {
      display: flex;
      justify-content: center;
      background: #007bff;
      padding: 10px;
      border-radius: 8px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    .tabs button {
      background: none;
      border: none;
      color: white;
      padding: 10px 20px;
      cursor: pointer;
      font-size: 20px;
      display: inline-flex;
      align-items: center;
      gap: 5px;
    }
    .tabs button:hover {
      background: rgba(255,255,255,0.2);
    }
    .section {
      margin-top: 20px;
      padding: 20px;
      border-radius: 8px;
      background: #ffffff;
      box-shadow: 0px 2px 4px rgba(0,0,0,0.1);
    }
    textarea, input[type="file"], input[type="number"] {
      width: 100%;
      margin-bottom: 15px;
      font-size: 16px;
      padding: 8px;
    }
    /* ë¼ë²¨ ê¸°ë³¸ */
    label {
      font-size: 16px;
      margin-right: 10px;
      display: inline-flex;
      align-items: center;
      gap: 5px;
    }
    button {
      background-color: #007bff;
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
      margin-top: 10px;
      display: inline-flex;
      align-items: center;
      gap: 5px;
    }
    button:hover {
      background-color: #0056b3;
    }
    /* ë¬¸ì œ í¼ ìŠ¤íƒ€ì¼ */
    #question-form .question-block {
      margin-bottom: 20px;
      padding: 10px;
      background-color: #f0f0f0;
      border-radius: 5px;
    }
    #generate {
      line-height: 2.0; /* ì›í•˜ëŠ” ìˆ˜ì¹˜ë¡œ ì¡°ì • */
    }
   
    #question-form .question-block p {
      margin: 5px 0;
    }
    /* ë¡œë”© í‘œì‹œ */
    #loading-indicator {
      display: none;
      margin-top: 10px;
      color: red;
      font-weight: bold;
    }
    /* ì •ë‹µ/í•´ì„¤, êµ­ë¬¸ í•´ì„ */
    #answer-section pre,
    #korean-section pre {
      white-space: pre-wrap;
      overflow-wrap: break-word;
      word-wrap: break-word;
    }
    @media print {
      .tabs, button, #loading-indicator {
        display: none;
      }
      .container {
        box-shadow: none;
      }
    }

    /* ë°˜ì‘í˜• ì²˜ë¦¬ (ì˜ˆ: í™”ë©´ë„ˆë¹„ 600px ì´í•˜) */
    @media (max-width: 600px) {
      body {
        padding: 10px;
      }
      h1 {
        font-size: 1.2rem;
      }
      .tabs button {
        margin-bottom: 5px;
        font-size: 14px;
        padding: 8px 16px;
      }
      .section {
        margin-top: 10px;
        padding: 15px;
      }
      label {
        font-size: 14px;
      }
      button {
        font-size: 14px;
      }
    }
  </style>
  <!-- Tesseract.js for OCR -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tesseract.js/2.1.4/tesseract.min.js"></script>
  <script>
    function showSection(sectionId) {
      const sections = ["upload", "generate", "check"];
      sections.forEach(id => {
        const sec = document.getElementById(id);
        if (sec) {
          sec.style.display = (id === sectionId) ? "block" : "none";
        }
      });
    }
  </script>
</head>
<body>
  <div class="container">
    <h1>âœ¨ì˜ì–´ ë…í•´ ë¬¸ì œ ìƒì„± ë§ˆë²•ì‚¬ âœ¨</h1>
    <div class="tabs">
      <button onclick="showSection('upload')">
        <i class="fas fa-upload"></i> ì§€ë¬¸ ì—…ë¡œë“œ
      </button>
      <button onclick="showSection('generate')">
        <i class="fas fa-cogs"></i> ë¬¸ì œ ìƒì„±
      </button>
      <button onclick="showSection('check')">
        <i class="far fa-eye"></i> ë¬¸ì œ í™•ì¸
      </button>
    </div>
    
    <!-- ì§€ë¬¸ ì—…ë¡œë“œ ì„¹ì…˜ -->
    <div id="upload" class="section">
      <h2><i class="fas fa-file-alt"></i> ì§€ë¬¸ ì—…ë¡œë“œ</h2>
      <textarea id="passage" placeholder="ì§€ë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”..." rows="6"></textarea>
      <input type="file" id="imageInput" accept="image/*">
      <button onclick="handleImageUpload()">
        <i class="fas fa-camera"></i> ì´ë¯¸ì§€ì—ì„œ í…ìŠ¤íŠ¸ ì¶”ì¶œ
      </button>
      <button onclick="showSection('generate')">
        <i class="fas fa-arrow-right"></i> ì…ë ¥ ì™„ë£Œ
      </button>
    </div>
    
    <!-- ë¬¸ì œ ìƒì„± ì„¹ì…˜ -->
    <div id="generate" class="section" style="display:none;">
      <h2><i class="fas fa-cogs"></i> ë¬¸ì œ ìƒì„±</h2>
      <!-- ìœ í˜• ì„ íƒ (ê°€ë¡œ ë°°ì¹˜) -->
      <h3>âœ… ë¬¸ì œ ìœ í˜• ì„ íƒ</h3>
      <div style="margin-bottom: 10px;">
        <label><input type="checkbox" class="problem-type" value="ì£¼ì œ ë° ëª©ì  íŒŒì•…" /> ì£¼ì œ ë° ëª©ì  íŒŒì•…</label>
        <label><input type="checkbox" class="problem-type" value="ì„¸ë¶€ ë‚´ìš© ì´í•´" /> ì„¸ë¶€ ë‚´ìš© ì´í•´</label>
        <label><input type="checkbox" class="problem-type" value="ë…¼ë¦¬ì  ê´€ê³„ íŒŒì•…" /> ë…¼ë¦¬ì  ê´€ê³„ íŒŒì•…</label>
        <label><input type="checkbox" class="problem-type" value="ì–´íœ˜ ì¶”ë¡ " /> ì–´íœ˜ ì¶”ë¡ </label>
        <label><input type="checkbox" class="problem-type" value="ë¹ˆì¹¸ ì¶”ë¡ " /> ë¹ˆì¹¸ ì¶”ë¡ </label>
        <label><input type="checkbox" class="problem-type" value="ê¸€ì˜ ìˆœì„œ íŒŒì•…" /> ê¸€ì˜ ìˆœì„œ íŒŒì•…</label>
        <label><input type="checkbox" class="problem-type" value="ì–´ë²•" /> ì–´ë²•</label>
      </div>

      <div style="margin-bottom: 10, margin-top: 10px;">
        <h3>âœ… ë¬¸í•­ ìˆ˜ ì„ íƒ</h3>
        <label>
          ğŸ‘‰ğŸ» ì „ì²´ ë¬¸í•­ ìˆ˜:
          <input type="number" id="totalQuestions" value="1" min="1" style="width:100px;">
        </label>
      </div>

      <button onclick="generateQuestion()">
        <i class="fas fa-check"></i> ì„ íƒ ì™„ë£Œ
      </button>
      <div id="loading-indicator">ë¬¸ì œ ìƒì„± ì¤‘... <i class="fas fa-hourglass-half"></i></div>
    </div>
    
    <!-- ë¬¸ì œ í™•ì¸ ì„¹ì…˜ -->
    <div id="check" class="section" style="display:none;">
      <h2><i class="far fa-eye"></i> ë¬¸ì œ í™•ì¸</h2>
      <!-- ë¬¸ì œ í¼ -->
      <div id="pdf-content">
        <form id="question-form">
          <!-- ë™ì ìœ¼ë¡œ ìƒì„±ëœ ë¬¸ì œ í‘œì‹œ -->
        </form>
      </div>

      <!-- í•˜ë‹¨ ë²„íŠ¼: ì •ë‹µ ë° í•´ì„¤ / êµ­ë¬¸ í•´ì„ -->
      <div style="margin-top:20px;">
        <button type="button" onclick="showAnswersAndExplanations()">
          <i class="fas fa-info-circle"></i> ì •ë‹µ ë° í•´ì„¤
        </button>
        <button type="button" onclick="showKoreanTranslation()">
          <i class="fas fa-language"></i> êµ­ë¬¸ í•´ì„
        </button>
      </div>

      <!-- ì •ë‹µ/í•´ì„¤ -->
      <div id="answer-section" style="margin-top: 20px; display: none;">
        <h3>ì •ë‹µ ë° í•´ì„¤</h3>
        <pre id="answers"></pre>
        <pre id="explanations"></pre>
        <button onclick="printPage()" style="margin-top:10px;">
          <i class="fas fa-print"></i> ì›¹ í˜ì´ì§€ ì¸ì‡„
        </button>
      </div>

      <!-- êµ­ë¬¸ í•´ì„ -->
      <div id="korean-section" style="margin-top: 20px; display: none;">
        <h3>êµ­ë¬¸ í•´ì„</h3>
        <pre id="korean-translation"></pre>
        <button onclick="printPage()" style="margin-top:10px;">
          <i class="fas fa-print"></i> ì›¹ í˜ì´ì§€ ì¸ì‡„
        </button>
      </div>
    </div>
  </div>

  <script>
    const WORKER_GENERATE_URL = "https://readingquiz.sehyunglee2015.workers.dev/api/generate";

    // ë§ˆì§€ë§‰ ìš”ì²­ ì‹œê° (ì¤‘ë³µ ìš”ì²­ ë°©ì§€ìš©)
    let lastRequestTime = 0;
    // ìµœì†Œ ìš”ì²­ ê°„ê²© (ms)
    const requestInterval = 5000;

    let originalQuestionsHTML = "";
    let correctAnswers = [];
    let explanations = [];
    let koreanTranslation = "";
    let userPassage = "";

    // ë¬¸ì œ ìƒì„± í•¨ìˆ˜
    async function generateQuestion() {
      // ì²˜ìŒì—” ìˆ¨ê¹€ (ì—ëŸ¬ ì‹œì— "ë¬¸ì œ ìƒì„± ì¤‘..."ì´ ì•„ì˜ˆ ì•ˆ ëœ¨ë„ë¡)
      const loadingEl = document.getElementById("loading-indicator");
      loadingEl.style.display = "none";

      const passage = document.getElementById("passage").value.trim();
      userPassage = passage;

      // ====== ìœ íš¨ì„± ê²€ì¦ ======
      // (1) ì§€ë¬¸ ì…ë ¥ ì—¬ë¶€
      if (!passage) {
        alert("ì§€ë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”.");
        return;  // ìœ íš¨ì„± ì‹¤íŒ¨ -> ë¡œë”©í‘œì‹œ ì ˆëŒ€ on í•˜ì§€ ì•ŠìŒ
      }
      // (2) ë¬¸ì œ ìœ í˜• ì²´í¬
      const checkboxes = document.querySelectorAll('.problem-type:checked');
      let selectedTypes = Array.from(checkboxes).map(cb => cb.value);
      if (selectedTypes.length === 0) {
        alert("ì ì–´ë„ í•˜ë‚˜ì˜ ë¬¸ì œ ìœ í˜•ì„ ì„ íƒí•´ ì£¼ì„¸ìš”.");
        return;  // return ì‹œ ë¡œë”©í‘œì‹œ X
      }
      // (3) ì´ ë¬¸í•­ ìˆ˜ ì²´í¬
      const totalQuestions = parseInt(document.getElementById("totalQuestions").value);
      if (isNaN(totalQuestions) || totalQuestions < selectedTypes.length) {
        alert("ì „ì²´ ë¬¸í•­ ìˆ˜ëŠ” ì„ íƒëœ ë¬¸ì œ ìœ í˜• ìˆ˜ ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.");
        return;  // return ì‹œ ë¡œë”©í‘œì‹œ X
      }
      // (4) ìš”ì²­ ê°„ê²© ì²´í¬
      const currentTime = Date.now();
      if (currentTime - lastRequestTime < requestInterval) {
        alert("ë„ˆë¬´ ìì£¼ ìš”ì²­í•˜ê³  ìˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
        return;  // return ì‹œ ë¡œë”©í‘œì‹œ X
      }
      lastRequestTime = currentTime;

      // ====== ëª¨ë“  ê²€ì‚¬ í†µê³¼ í›„, ì‹¤ì œ ë¬¸ì œ ìƒì„± ìš”ì²­ ì „ ë¡œë”© í‘œì‹œ ======
      loadingEl.style.display = "block";

      try {
        // API ìš”ì²­
        const response = await fetch(WORKER_GENERATE_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            passage,
            selectedTypes,
            totalQuestions
          })
        });

        if (!response.ok) {
          const msg = await response.text();
          throw new Error(`ì„œë²„ ì˜¤ë¥˜: ${response.status} / ${msg}`);
        }

        const data = await response.json();
        if (data.error) {
          throw new Error(data.error);
        }

        const resultJSON = data.resultJSON;
        if (!resultJSON || !resultJSON.questions) {
          throw new Error("ë¬¸ì œ ìƒì„± ê²°ê³¼ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.");
        }

        const questionForm = document.getElementById("question-form");
        questionForm.innerHTML = "";

        correctAnswers = resultJSON.answers || [];
        explanations = resultJSON.explanations || [];
        koreanTranslation = resultJSON.koreanTranslation || "";

        if (!resultJSON.questions) {
          throw new Error("ë¬¸í•­ ë°ì´í„° ì—†ìŒ");
        }

        // ë¬¸ì œ í‘œì‹œ
        resultJSON.questions.forEach((q, idx) => {
          const qDiv = document.createElement("div");
          qDiv.className = "question-block";

          // ì§€ì‹œë¬¸ + ë³¸ë¬¸ ë¶„ë¦¬
          let parts = q.question.split("\n");
          const instruction = parts[0]?.trim() || "";
          const bodyText = parts.slice(1).join("\n").trim();

          const numP = document.createElement("p");
          numP.textContent = q.number + ". " + instruction;
          qDiv.appendChild(numP);

          const bodyP = document.createElement("p");
          bodyP.textContent = bodyText;
          qDiv.appendChild(bodyP);

          if (q.choices) {
            q.choices.forEach(choice => {
              const label = document.createElement("label");
              label.style.display = "block";
              label.textContent = choice;
              qDiv.appendChild(label);
            });
          }

          questionForm.appendChild(qDiv);
        });

        originalQuestionsHTML = questionForm.innerHTML;
        
        // ë¬¸ì œ ìƒì„± ì„±ê³µ ì‹œ ë¡œë”© í‘œì‹œ ë„ê³  í™•ì¸ íƒ­ìœ¼ë¡œ ì´ë™
        loadingEl.style.display = "none";
        showSection('check');

      } catch (err) {
        // ====== ì—ëŸ¬ ë°œìƒ ì‹œ ë¡œë”© í‘œì‹œ ì œê±° ======
        loadingEl.style.display = "none";
        console.error("ë¬¸ì œ ìƒì„± ì¤‘ ì˜¤ë¥˜:", err);
        alert("ë¬¸ì œ ìƒì„± ì‹¤íŒ¨: " + err.message);
      }
    }

    // ì •ë‹µ ë° í•´ì„¤ í‘œì‹œ
    function showAnswersAndExplanations() {
      document.getElementById("answer-section").style.display = "block";
      document.getElementById("korean-section").style.display = "none";

      const ansElem = document.getElementById("answers");
      const expElem = document.getElementById("explanations");

      if (!correctAnswers || correctAnswers.length === 0) {
        ansElem.textContent = "ì •ë‹µ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.";
      } else {
        ansElem.textContent = correctAnswers
          .map((ans, i) => `${i+1}ë²ˆ ì •ë‹µ: ${ans}`)
          .join("\n");
      }

      if (!explanations || explanations.length === 0) {
        expElem.textContent = "í•´ì„¤ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.";
      } else {
        expElem.textContent = explanations
          .map((ex, i) => `${i+1}ë²ˆ í•´ì„¤: ${ex}`)
          .join("\n\n");
      }
    }

    // êµ­ë¬¸ í•´ì„ í‘œì‹œ
    function showKoreanTranslation() {
      document.getElementById("answer-section").style.display = "none";
      document.getElementById("korean-section").style.display = "block";

      const korElem = document.getElementById("korean-translation");
      if (!koreanTranslation) {
        korElem.textContent = "êµ­ë¬¸ í•´ì„ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.";
      } else {
        korElem.textContent = koreanTranslation;
      }
    }

    // í˜ì´ì§€ ì¸ì‡„
    function printPage() {
      window.print();
    }

    // ì´ë¯¸ì§€ -> í…ìŠ¤íŠ¸ (OCR)
    async function handleImageUpload() {
      const imageInput = document.getElementById('imageInput');
      const passageTextarea = document.getElementById('passage');
      if (imageInput.files && imageInput.files[0]) {
        const imageFile = imageInput.files[0];
        try {
          const { data: { text } } = await Tesseract.recognize(imageFile, 'eng', { logger: m => console.log(m) });
          passageTextarea.value = text;
          alert('ì´ë¯¸ì§€ì—ì„œ í…ìŠ¤íŠ¸ ì¶”ì¶œ ì™„ë£Œ!');
        } catch (error) {
          console.error("OCR Error:", error);
          alert('ì´ë¯¸ì§€ì—ì„œ í…ìŠ¤íŠ¸ ì¶”ì¶œ ì‹¤íŒ¨: ' + error);
        }
      } else {
        alert('ì´ë¯¸ì§€ íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
      }
    }

    // ì „ì—­ì— ë…¸ì¶œ
    window.handleImageUpload = handleImageUpload;
    window.generateQuestion = generateQuestion;
    window.showAnswersAndExplanations = showAnswersAndExplanations;
    window.showKoreanTranslation = showKoreanTranslation;
    window.printPage = printPage;
  </script>
</body>
</html>
