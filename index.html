<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>영어 독해 문제 생성기</title>
  <!-- Font Awesome -->
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
    crossorigin="anonymous"
  />
  <style>
    /* 기본 스타일 초기화 */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    /* 페이지 기본 배경/컨테이너 */
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: Arial, sans-serif;
      -webkit-font-smoothing: antialiased;
    }
    body {
      background-color: #f8f9fa;
    }
    .container {
      max-width: 900px;
      margin: 20px auto;
      background: #fff;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    h1 {
      text-align: center;
      color: #007bff;
      margin-bottom: 20px;
    }

    /* 탭 메뉴 */
    .tabs {
      display: flex;
      justify-content: center;
      background: #007bff;
      padding: 10px;
      border-radius: 8px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    .tabs button {
      background: none;
      border: none;
      color: white;
      padding: 10px 20px;
      cursor: pointer;
      font-size: 16px;
      display: inline-flex;
      align-items: center;
      gap: 5px;
    }
    .tabs button:hover {
      background: rgba(255,255,255,0.2);
    }

    /* 섹션 공통 스타일 */
    .section {
      margin-top: 20px;
      padding: 20px;
      border-radius: 8px;
      background: #ffffff;
      box-shadow: 0px 2px 4px rgba(0,0,0,0.1);
    }
    textarea, input[type="file"], input[type="number"] {
      width: 100%;
      margin-bottom: 15px;
      font-size: 16px;
      padding: 8px;
    }
    label {
      font-size: 16px;
      margin-right: 10px;
      display: inline-flex;
      align-items: center;
      gap: 5px;
    }
    button {
      background-color: #007bff;
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
      margin-top: 10px;
      display: inline-flex;
      align-items: center;
      gap: 5px;
    }
    button:hover {
      background-color: #0056b3;
    }

    /* 문제 폼 스타일 */
    #question-form .question-block {
      margin-bottom: 20px;
      padding: 10px;
      background-color: #f0f0f0;
      border-radius: 5px;
    }
    #question-form .question-block p {
      margin: 5px 0;
    }

    /* 로딩 표시 */
    #loading-indicator {
      display: none;
      margin-top: 10px;
      color: red;
      font-weight: bold;
    }

    /* 정답/해설, 국문 해석 영역 */
    #answer-section pre,
    #korean-section pre {
      white-space: pre-wrap;
      overflow-wrap: break-word;
      word-wrap: break-word;
    }

    /* 인쇄 시 숨길 요소들 */
    @media print {
      .tabs, button, #loading-indicator {
        display: none;
      }
      .container {
        box-shadow: none;
      }
    }

    /* 반응형 예시 */
    @media (max-width: 600px) {
      .container {
        margin: 10px auto;
        padding: 15px;
      }
      .tabs button {
        font-size: 14px;
        padding: 8px 16px;
        margin-bottom: 5px;
      }
      .section {
        margin-top: 10px;
        padding: 15px;
      }
      button {
        font-size: 14px;
      }
    }

    /* 활동 생성 결과 스타일 */
    #activityOutput {
      margin-top: 20px;
      padding: 10px;
      background-color: #f0f0f0;
      border-radius: 5px;
    }
  </style>

  <!-- Tesseract.js (OCR) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tesseract.js/2.1.4/tesseract.min.js"></script>
  <script>
    function showSection(sectionId) {
      const sections = ["upload", "generate", "check", "activity"];
      sections.forEach(id => {
        const sec = document.getElementById(id);
        if (sec) {
          sec.style.display = (id === sectionId) ? "block" : "none";
        }
      });
    }

    // 이미지 -> OCR
    async function handleImageUpload() {
      const imageInput = document.getElementById('imageInput');
      const passageTextarea = document.getElementById('passage');
      if (imageInput.files && imageInput.files[0]) {
        const imageFile = imageInput.files[0];
        try {
          const { data: { text } } = await Tesseract.recognize(
            imageFile,
            'eng',
            { logger: m => console.log(m) }
          );
          passageTextarea.value = text;
          alert('이미지에서 텍스트 추출 완료!');
        } catch (error) {
          console.error("OCR Error:", error);
          alert('이미지에서 텍스트를 추출 실패: ' + error);
        }
      } else {
        alert('이미지 파일을 선택해주세요.');
      }
    }

    // /api/generate 문제 생성
    let lastRequestTime = 0;
    const requestInterval = 15000;
    let originalQuestionsHTML = "";
    let correctAnswers = [];
    let explanations = [];
    let koreanTranslation = "";
    let userPassage = "";

    async function generateQuestion() {
      document.getElementById("loading-indicator").style.display = "block";

      const passage = document.getElementById("passage").value.trim();
      userPassage = passage;
      if (!passage) {
        alert("지문을 입력하세요.");
        document.getElementById("loading-indicator").style.display = "none";
        return;
      }

      const checkboxes = document.querySelectorAll('.problem-type:checked');
      let selectedTypes = Array.from(checkboxes).map(cb => cb.value);
      if (selectedTypes.length === 0) {
        alert("적어도 하나의 문제 유형을 선택해 주세요.");
        document.getElementById("loading-indicator").style.display = "none";
        return;
      }

      const totalQuestions = parseInt(document.getElementById("totalQuestions").value);
      if (isNaN(totalQuestions) || totalQuestions < selectedTypes.length) {
        alert("전체 문항 수는 선택된 문제 유형 수 이상이어야 합니다.");
        document.getElementById("loading-indicator").style.display = "none";
        return;
      }

      const currentTime = Date.now();
      if (currentTime - lastRequestTime < requestInterval) {
        alert("너무 자주 요청하고 있습니다. 잠시 후 다시 시도해주세요.");
        document.getElementById("loading-indicator").style.display = "none";
        return;
      }
      lastRequestTime = currentTime;

      try {
        const response = await fetch("https://readingquiz.sehyunglee2015.workers.dev/api/generate", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            passage,
            selectedTypes,
            totalQuestions
          })
        });

        if (!response.ok) {
          const msg = await response.text();
          throw new Error(`서버 오류: ${response.status} / ${msg}`);
        }

        const data = await response.json();
        if (data.error) {
          throw new Error(data.error);
        }

        const resultJSON = data.resultJSON;
        if (!resultJSON || !resultJSON.questions) {
          throw new Error("문제 생성 결과가 올바르지 않습니다.");
        }

        const questionForm = document.getElementById("question-form");
        questionForm.innerHTML = "";

        correctAnswers = resultJSON.answers || [];
        explanations = resultJSON.explanations || [];
        koreanTranslation = resultJSON.koreanTranslation || "";

        if (!resultJSON.questions) {
          throw new Error("문항 데이터 없음");
        }
        resultJSON.questions.forEach((q, idx) => {
          const qDiv = document.createElement("div");
          qDiv.className = "question-block";

          let parts = q.question.split("\n");
          const instruction = parts[0]?.trim() || "";
          const bodyText = parts.slice(1).join("\n").trim();

          const numP = document.createElement("p");
          numP.textContent = q.number + ". " + instruction;
          qDiv.appendChild(numP);

          const bodyP = document.createElement("p");
          bodyP.textContent = bodyText;
          qDiv.appendChild(bodyP);

          if (q.choices) {
            q.choices.forEach(choice => {
              const label = document.createElement("label");
              label.style.display = "block";
              label.textContent = choice;
              qDiv.appendChild(label);
            });
          }
          questionForm.appendChild(qDiv);
        });

        originalQuestionsHTML = questionForm.innerHTML;
        document.getElementById("loading-indicator").style.display = "none";
        showSection('check');
      } catch (err) {
        console.error("문제 생성 중 오류:", err);
        alert("문제 생성 실패: " + err.message);
        document.getElementById("loading-indicator").style.display = "none";
      }
    }

    function showAnswersAndExplanations() {
      document.getElementById("answer-section").style.display = "block";
      document.getElementById("korean-section").style.display = "none";

      const ansElem = document.getElementById("answers");
      const expElem = document.getElementById("explanations");

      if (!correctAnswers || correctAnswers.length === 0) {
        ansElem.textContent = "정답 정보가 없습니다.";
      } else {
        ansElem.textContent = correctAnswers.map((ans, i) => `${i+1}번 정답: ${ans}`).join("\n");
      }
      if (!explanations || explanations.length === 0) {
        expElem.textContent = "해설 정보가 없습니다.";
      } else {
        expElem.textContent = explanations.map((ex, i) => `${i+1}번 해설: ${ex}`).join("\n\n");
      }
    }

    function showKoreanTranslation() {
      document.getElementById("answer-section").style.display = "none";
      document.getElementById("korean-section").style.display = "block";

      const korElem = document.getElementById("korean-translation");
      if (!koreanTranslation) {
        korElem.textContent = "국문 해석 정보가 없습니다.";
      } else {
        korElem.textContent = koreanTranslation;
      }
    }

    function printPage() {
      window.print();
    }

    // *** 활동 생성 ***
    let activityData = null; // 생성된 활동 JSON
    async function generateActivity() {
      const passage = document.getElementById("passage").value.trim();
      if (!passage) {
        alert("지문을 먼저 업로드하거나 입력하세요!");
        return;
      }
      const checks = document.querySelectorAll('.activity-type:checked');
      if (!checks.length) {
        alert("최소 한 개 이상의 활동을 선택해주세요.");
        return;
      }
      const selectedActs = Array.from(checks).map(c => c.value);

      try {
        const resp = await fetch("https://readingquiz.sehyunglee2015.workers.dev/api/activity", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            passage,
            activities: selectedActs
          })
        });
        if (!resp.ok) {
          const msg = await resp.text();
          throw new Error(`활동 생성 API 오류: ${resp.status} / ${msg}`);
        }
        const data = await resp.json();
        if (data.error) {
          throw new Error(data.error);
        }
        const result = data.result;
        if (!result || !Array.isArray(result.activities)) {
          throw new Error("올바르지 않은 활동 데이터");
        }
        activityData = result; // 저장해두고 정답 보기 기능에서 사용

        const outputDiv = document.getElementById("activityOutput");
        let html = "<h3>활동 결과</h3>";
        
        result.activities.forEach((act, idx) => {
          // 활동 구분 공백
          if (idx > 0) {
            html += `<div style="margin: 1rem 0;"></div>`;
          }
          html += `<h4>${act.type}</h4>`;

          // 단어 및 주요 표현 익히기
          if (act.type === "단어 및 주요 표현 익히기" && act.items) {
            // 1), 2), 3) numbering
            act.items.forEach((item, i) => {
              // item => { vocab, meaning, note, possibly answer? }
              // 원하는 형식: "1) run: 달리다  __________________"
              html += `
                <p>
                  ${i+1}) <strong>${item.vocab}</strong>: ${item.meaning}
                  &nbsp; <u style="display:inline-block; min-width: 150px;">&nbsp;</u>
                </p>
              `;
            });
          }
          // 영어 문장 해석하기
          else if (act.type === "영어 문장 해석하기" && act.sentences) {
            // 1), 2), 3)...
            act.sentences.forEach((s, i) => {
              // { original, blank, answer? }
              // 빈칸을 문장 길이 x 1.2 => 일단 approximate
              const len = Math.round(s.original.length * 1.2);
              let line = "";
              for (let k=0; k<len; k++) line += "_";
              html += `
                <p>
                  ${i+1}) ${s.original}
                  <br />해석: <u style="display:inline-block;">${line}</u>
                </p>
              `;
            });
          }
          // 우리말 영어로 번역하기
          else if (act.type === "우리말 영어로 번역하기" && act.list) {
            act.list.forEach((row, i) => {
              // row => { korean, blank, answer? }
              const len = Math.round(row.korean.length * 1.2);
              let line = "";
              for (let k=0; k<len; k++) line += "_";
              html += `
                <p>
                  ${i+1}) ${row.korean}
                  <br />영어: <u style="display:inline-block;">${line}</u>
                </p>
              `;
            });
          }
          // 문법 변형 활동
          else if (act.type === "문법 변형 활동" && act.examples) {
            act.examples.forEach((ex, i) => {
              // ex => { instruction, original, answer? }
              html += `
                <p>
                  ${i+1}) [${ex.instruction}]<br />
                  원문: ${ex.original}
                  <br />변형: <u style="display:inline-block; min-width:180px;">&nbsp;</u>
                </p>
              `;
            });
          }
          else {
            html += `<p>해당 활동에 대한 데이터가 없습니다.</p>`;
          }
        });

        // 하단 버튼들
        html += `
          <div style="margin-top:20px;">
            <button onclick="printPage()">
              <i class="fas fa-print"></i> 웹 페이지 인쇄
            </button>
            <button onclick="showActivityAnswers()">
              <i class="fas fa-eye"></i> 정답 보기
            </button>
          </div>
        `;

        outputDiv.innerHTML = html;

      } catch (err) {
        console.error("활동 생성 에러:", err);
        alert("활동 생성 실패: " + err.message);
      }
    }

    // 활동 정답 보기
    function showActivityAnswers() {
      if (!activityData) {
        alert("활동 데이터가 없습니다.");
        return;
      }
      // activityData.activities => each item has optional "answer"
      // 본문에는 정답 미리 표시 X, 클릭 시 표시
      // => we re-render with answer if it exists
      const outputDiv = document.getElementById("activityOutput");
      let html = "<h3>활동 결과 (정답 보기)</h3>";
      
      activityData.activities.forEach((act, idx) => {
        if (idx > 0) {
          html += `<div style="margin: 1rem 0;"></div>`;
        }
        html += `<h4>${act.type}</h4>`;

        if (act.type === "단어 및 주요 표현 익히기" && act.items) {
          act.items.forEach((item, i) => {
            const len = item.meaning.length * 1.2;
            html += `
              <p>
                ${i+1}) <strong>${item.vocab}</strong>: ${item.meaning}
                &nbsp; <u style="display:inline-block; min-width:150px;">&nbsp;</u>
            `;
            if (item.answer) {
              html += `<br />[정답] ${item.answer}`;
            }
            html += `</p>`;
          });
        }
        else if (act.type === "영어 문장 해석하기" && act.sentences) {
          act.sentences.forEach((s, i) => {
            const len = Math.round(s.original.length * 1.2);
            let line = "";
            for (let k=0; k<len; k++) line += "_";
            html += `
              <p>
                ${i+1}) ${s.original}
                <br />해석: <u style="display:inline-block;">${line}</u>
            `;
            if (s.answer) {
              html += `<br />[정답] ${s.answer}`;
            }
            html += `</p>`;
          });
        }
        else if (act.type === "우리말 영어로 번역하기" && act.list) {
          act.list.forEach((row, i) => {
            const len = Math.round(row.korean.length * 1.2);
            let line = "";
            for (let k=0; k<len; k++) line += "_";
            html += `
              <p>
                ${i+1}) ${row.korean}
                <br />영어: <u style="display:inline-block;">${line}</u>
            `;
            if (row.answer) {
              html += `<br />[정답] ${row.answer}`;
            }
            html += `</p>`;
          });
        }
        else if (act.type === "문법 변형 활동" && act.examples) {
          act.examples.forEach((ex, i) => {
            html += `
              <p>
                ${i+1}) [${ex.instruction}]<br />
                원문: ${ex.original}
                <br />변형: <u style="display:inline-block; min-width:180px;">&nbsp;</u>
            `;
            if (ex.answer) {
              html += `<br />[정답] ${ex.answer}`;
            }
            html += `</p>`;
          });
        }
        else {
          html += `<p>해당 활동에 대한 데이터가 없습니다.</p>`;
        }
      });

      html += `
        <div style="margin-top:20px;">
          <button onclick="printPage()">
            <i class="fas fa-print"></i> 웹 페이지 인쇄
          </button>
        </div>
      `;
      outputDiv.innerHTML = html;
    }

    window.handleImageUpload = handleImageUpload;
    window.generateQuestion = generateQuestion;
    window.showAnswersAndExplanations = showAnswersAndExplanations;
    window.showKoreanTranslation = showKoreanTranslation;
    window.printPage = printPage;
    window.generateActivity = generateActivity;
    window.showActivityAnswers = showActivityAnswers;
  </script>
</head>
<body>
  <div class="container">
    <h1>영어 독해 문제 생성기</h1>

    <!-- 탭 메뉴 -->
    <div class="tabs">
      <button onclick="showSection('upload')">
        <i class="fas fa-upload"></i> 지문 업로드
      </button>
      <button onclick="showSection('generate')">
        <i class="fas fa-cogs"></i> 문제 생성
      </button>
      <button onclick="showSection('check')">
        <i class="far fa-eye"></i> 문제 확인
      </button>
      <button onclick="showSection('activity')">
        <i class="fas fa-chalkboard-teacher"></i> 활동 생성
      </button>
    </div>

    <!-- 1) 지문 업로드 섹션 -->
    <div id="upload" class="section">
      <h2><i class="fas fa-file-alt"></i> 지문 업로드</h2>
      <textarea id="passage" placeholder="지문을 입력하세요..." rows="6"></textarea>
      <input type="file" id="imageInput" accept="image/*">
      <button onclick="handleImageUpload()">
        <i class="fas fa-camera"></i> 이미지에서 텍스트 추출
      </button>
      <button onclick="showSection('generate')">
        <i class="fas fa-arrow-right"></i> 입력 완료
      </button>
    </div>
    
    <!-- 2) 문제 생성 섹션 -->
    <div id="generate" class="section" style="display:none;">
      <h2><i class="fas fa-cogs"></i> 문제 생성</h2>
      <h3>문제 유형 선택</h3>
      <div style="margin-bottom: 10px;">
        <label><input type="checkbox" class="problem-type" value="주제 및 목적 파악" /> 주제 및 목적 파악</label>
        <label><input type="checkbox" class="problem-type" value="세부 내용 이해" /> 세부 내용 이해</label>
        <label><input type="checkbox" class="problem-type" value="논리적 관계 파악" /> 논리적 관계 파악</label>
        <label><input type="checkbox" class="problem-type" value="어휘 추론" /> 어휘 추론</label>
        <label><input type="checkbox" class="problem-type" value="빈칸 추론" /> 빈칸 추론</label>
        <label><input type="checkbox" class="problem-type" value="글의 순서 파악" /> 글의 순서 파악</label>
        <label><input type="checkbox" class="problem-type" value="어법" /> 어법</label>
      </div>
      <div style="margin-bottom: 10px;">
        <h3>문항 수 선택</h3>
        <label>
          전체 문항 수:
          <input type="number" id="totalQuestions" value="1" min="1" style="width:60px;">
        </label>
      </div>
      <button onclick="generateQuestion()">
        <i class="fas fa-check"></i> 선택 완료
      </button>
      <div id="loading-indicator">문제 생성 중... <i class="fas fa-hourglass-half"></i></div>
    </div>
    
    <!-- 3) 문제 확인 섹션 -->
    <div id="check" class="section" style="display:none;">
      <h2><i class="far fa-eye"></i> 문제 확인</h2>
      <div id="pdf-content">
        <form id="question-form">
          <!-- 동적으로 생성된 문제들 표시 (generateQuestion) -->
        </form>
      </div>
      <div style="margin-top:20px;">
        <button type="button" onclick="showAnswersAndExplanations()">
          <i class="fas fa-info-circle"></i> 정답 및 해설
        </button>
        <button type="button" onclick="showKoreanTranslation()">
          <i class="fas fa-language"></i> 국문 해석
        </button>
      </div>
      <div id="answer-section" style="margin-top: 20px; display: none;">
        <h3>정답 및 해설</h3>
        <pre id="answers"></pre>
        <pre id="explanations"></pre>
        <button onclick="printPage()" style="margin-top:10px;">
          <i class="fas fa-print"></i> 웹 페이지 인쇄
        </button>
      </div>
      <div id="korean-section" style="margin-top: 20px; display: none;">
        <h3>국문 해석</h3>
        <pre id="korean-translation"></pre>
        <button onclick="printPage()" style="margin-top:10px;">
          <i class="fas fa-print"></i> 웹 페이지 인쇄
        </button>
      </div>
    </div>

    <!-- 4) 활동 생성 섹션 -->
    <div id="activity" class="section" style="display:none;">
      <h2><i class="fas fa-chalkboard-teacher"></i> 활동 생성</h2>
      <p>생성할 활동을 선택하세요:</p>
      <div style="margin-bottom: 15px;">
        <label><input type="checkbox" class="activity-type" value="단어 및 주요 표현 익히기"> 단어 및 주요 표현 익히기</label><br/>
        <label><input type="checkbox" class="activity-type" value="영어 문장 해석하기"> 영어 문장 해석하기</label><br/>
        <label><input type="checkbox" class="activity-type" value="우리말 영어로 번역하기"> 우리말 영어로 번역하기</label><br/>
        <label><input type="checkbox" class="activity-type" value="문법 변형 활동"> 문법 변형 활동</label><br/>
      </div>
      <button onclick="generateActivity()">
        <i class="fas fa-play"></i> 활동 생성
      </button>
      <div id="activityOutput"></div>
    </div>
  </div>
</body>
</html>
