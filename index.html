<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>영어 독해 문제 생성기</title>
  <!-- Font Awesome for icons -->
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
    crossorigin="anonymous"
  />
  <style>
    /* 기본 초기화 */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: Arial, sans-serif;
      -webkit-font-smoothing: antialiased;
    }
    body {
      background-color: #f8f9fa;
    }
    .container {
      max-width: 900px;
      margin: 20px auto;
      background: #fff;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    h1 {
      text-align: center;
      color: #007bff;
      margin-bottom: 20px;
    }
    .tabs {
      display: flex;
      justify-content: center;
      background: #007bff;
      padding: 10px;
      border-radius: 8px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    .tabs button {
      background: none;
      border: none;
      color: white;
      padding: 10px 20px;
      cursor: pointer;
      font-size: 16px;
      display: inline-flex;
      align-items: center;
      gap: 5px;
    }
    .tabs button:hover {
      background: rgba(255,255,255,0.2);
    }
    .section {
      margin-top: 20px;
      padding: 20px;
      border-radius: 8px;
      background: #ffffff;
      box-shadow: 0px 2px 4px rgba(0,0,0,0.1);
    }
    textarea, input[type="file"], input[type="number"] {
      width: 100%;
      margin-bottom: 15px;
      font-size: 16px;
      padding: 8px;
    }
    label {
      font-size: 16px;
      margin-right: 10px;
      display: inline-flex;
      align-items: center;
      gap: 5px;
    }
    button {
      background-color: #007bff;
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
      margin-top: 10px;
      display: inline-flex;
      align-items: center;
      gap: 5px;
    }
    button:hover {
      background-color: #0056b3;
    }

    /* 문제 폼 스타일 */
    #question-form .question-block {
      margin-bottom: 20px;
      padding: 10px;
      background-color: #f0f0f0;
      border-radius: 5px;
    }
    #question-form .question-block p {
      margin: 5px 0;
    }

    /* 로딩 표시 */
    #loading-indicator, #activity-loading-indicator {
      display: none;
      margin-top: 10px;
      color: red;
      font-weight: bold;
    }

    /* 정답/해설, 국문 해석 영역 */
    #answer-section pre,
    #korean-section pre {
      white-space: pre-wrap;
      overflow-wrap: break-word;
      word-wrap: break-word;
    }

    /* 인쇄 시 숨길 요소들 */
    @media print {
      .tabs, button, #loading-indicator, #activity-loading-indicator {
        display: none !important;
      }
      .container {
        box-shadow: none;
      }
    }

    /* 반응형 */
    @media (max-width: 600px) {
      .container {
        margin: 10px auto;
        padding: 15px;
      }
      .tabs button {
        font-size: 14px;
        padding: 8px 16px;
        margin-bottom: 5px;
      }
      .section {
        margin-top: 10px;
        padding: 15px;
      }
      button {
        font-size: 14px;
      }
    }

    /* 활동 생성 결과/확인 */
    #activityOutputView {
      margin-top: 20px;
      padding: 10px;
      background-color: #f0f0f0;
      border-radius: 5px;
      line-height: 1.6; /* 줄간격 넓힘 */
    }
  </style>

  <!-- Tesseract.js (OCR) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tesseract.js/2.1.4/tesseract.min.js"></script>
  <script>
    function showSection(sectionId) {
      const sections = ["upload", "generate", "check", "activity", "activityCheck"];
      sections.forEach(id => {
        const sec = document.getElementById(id);
        if (sec) {
          sec.style.display = (id === sectionId) ? "block" : "none";
        }
      });
    }

    // 이미지 -> OCR
    async function handleImageUpload() {
      const imageInput = document.getElementById('imageInput');
      const passageTextarea = document.getElementById('passage');
      if (imageInput.files && imageInput.files[0]) {
        const imageFile = imageInput.files[0];
        try {
          const { data: { text } } = await Tesseract.recognize(
            imageFile,
            'eng',
            { logger: m => console.log(m) }
          );
          passageTextarea.value = text;
          alert('이미지에서 텍스트 추출 완료!');
        } catch (error) {
          console.error("OCR Error:", error);
          alert('이미지에서 텍스트 추출 실패: ' + error);
        }
      } else {
        alert('이미지 파일을 선택해주세요.');
      }
    }

    // *** 문제 생성 ***
    let lastRequestTime = 0;
    const requestInterval = 15000;
    let originalQuestionsHTML = "";
    let correctAnswers = [];
    let explanations = [];
    let koreanTranslation = "";
    let userPassage = "";

    async function generateQuestion() {
      document.getElementById("loading-indicator").style.display = "block";

      const passage = document.getElementById("passage").value.trim();
      userPassage = passage;
      if (!passage) {
        alert("지문을 입력하세요.");
        document.getElementById("loading-indicator").style.display = "none";
        return;
      }

      const checkboxes = document.querySelectorAll('.problem-type:checked');
      let selectedTypes = Array.from(checkboxes).map(cb => cb.value);
      if (selectedTypes.length === 0) {
        alert("적어도 하나의 문제 유형을 선택해 주세요.");
        document.getElementById("loading-indicator").style.display = "none";
        return;
      }

      const totalQuestions = parseInt(document.getElementById("totalQuestions").value);
      if (isNaN(totalQuestions) || totalQuestions < selectedTypes.length) {
        alert("전체 문항 수는 선택된 문제 유형 수 이상이어야 합니다.");
        document.getElementById("loading-indicator").style.display = "none";
        return;
      }

      const currentTime = Date.now();
      if (currentTime - lastRequestTime < requestInterval) {
        alert("너무 자주 요청하고 있습니다. 잠시 후 다시 시도해주세요.");
        document.getElementById("loading-indicator").style.display = "none";
        return;
      }
      lastRequestTime = currentTime;

      try {
        const response = await fetch("https://readingquiz.sehyunglee2015.workers.dev/api/generate", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            passage,
            selectedTypes,
            totalQuestions
          })
        });

        if (!response.ok) {
          const msg = await response.text();
          throw new Error(`서버 오류: ${response.status} / ${msg}`);
        }

        const data = await response.json();
        if (data.error) {
          throw new Error(data.error);
        }

        const resultJSON = data.resultJSON;
        if (!resultJSON || !resultJSON.questions) {
          throw new Error("문제 생성 결과가 올바르지 않습니다.");
        }

        const questionForm = document.getElementById("question-form");
        questionForm.innerHTML = "";

        correctAnswers = resultJSON.answers || [];
        explanations = resultJSON.explanations || [];
        koreanTranslation = resultJSON.koreanTranslation || "";

        if (!resultJSON.questions) {
          throw new Error("문항 데이터 없음");
        }
        resultJSON.questions.forEach((q, idx) => {
          const qDiv = document.createElement("div");
          qDiv.className = "question-block";

          let parts = q.question.split("\n");
          const instruction = parts[0]?.trim() || "";
          const bodyText = parts.slice(1).join("\n").trim();

          const numP = document.createElement("p");
          numP.textContent = q.number + ". " + instruction;
          qDiv.appendChild(numP);

          const bodyP = document.createElement("p");
          bodyP.textContent = bodyText;
          qDiv.appendChild(bodyP);

          if (q.choices) {
            q.choices.forEach(choice => {
              const label = document.createElement("label");
              label.style.display = "block";
              label.textContent = choice;
              qDiv.appendChild(label);
            });
          }
          questionForm.appendChild(qDiv);
        });

        originalQuestionsHTML = questionForm.innerHTML;
        document.getElementById("loading-indicator").style.display = "none";
        showSection('check');
      } catch (err) {
        console.error("문제 생성 중 오류:", err);
        alert("문제 생성 실패: " + err.message);
        document.getElementById("loading-indicator").style.display = "none";
      }
    }

    function showAnswersAndExplanations() {
      document.getElementById("answer-section").style.display = "block";
      document.getElementById("korean-section").style.display = "none";

      const ansElem = document.getElementById("answers");
      const expElem = document.getElementById("explanations");

      if (!correctAnswers || correctAnswers.length === 0) {
        ansElem.textContent = "정답 정보가 없습니다.";
      } else {
        ansElem.textContent = correctAnswers.map((ans, i) => `${i+1}번 정답: ${ans}`).join("\n");
      }
      if (!explanations || explanations.length === 0) {
        expElem.textContent = "해설 정보가 없습니다.";
      } else {
        expElem.textContent = explanations.map((ex, i) => `${i+1}번 해설: ${ex}`).join("\n\n");
      }
    }

    function showKoreanTranslation() {
      document.getElementById("answer-section").style.display = "none";
      document.getElementById("korean-section").style.display = "block";

      const korElem = document.getElementById("korean-translation");
      if (!koreanTranslation) {
        korElem.textContent = "국문 해석 정보가 없습니다.";
      } else {
        korElem.textContent = koreanTranslation;
      }
    }

    function printPage() {
      window.print();
    }

    // *** 활동 생성 ***
    let activityData = null; // 생성된 활동 JSON
    async function generateActivity() {
      const passage = document.getElementById("passage").value.trim();
      if (!passage) {
        alert("지문을 먼저 업로드하거나 입력하세요!");
        return;
      }
      const checks = document.querySelectorAll('.activity-type:checked');
      if (!checks.length) {
        alert("최소 한 개 이상의 활동을 선택해주세요.");
        return;
      }
      const selectedActs = Array.from(checks).map(c => c.value);

      document.getElementById("activity-loading-indicator").style.display = "block";

      try {
        const resp = await fetch("https://readingquiz.sehyunglee2015.workers.dev/api/activity", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            passage,
            activities: selectedActs
          })
        });
        if (!resp.ok) {
          const msg = await resp.text();
          throw new Error(`활동 생성 API 오류: ${resp.status} / ${msg}`);
        }
        const data = await resp.json();
        if (data.error) {
          throw new Error(data.error);
        }
        const result = data.result;
        if (!result || !Array.isArray(result.activities)) {
          throw new Error("올바르지 않은 활동 데이터");
        }

        activityData = result;
        document.getElementById("activity-loading-indicator").style.display = "none";
        showSection('activityCheck');

        renderActivity(false);

      } catch (err) {
        console.error("활동 생성 에러:", err);
        alert("활동 생성 실패: " + err.message);
        document.getElementById("activity-loading-indicator").style.display = "none";
      }
    }

    // 활동 확인 페이지에서 출력 (showAnswers=false/true)
    function renderActivity(showAnswers) {
      if (!activityData) {
        document.getElementById("activityOutputView").innerHTML = "<p>아직 생성된 활동이 없습니다.</p>";
        return;
      }
      const outputDiv = document.getElementById("activityOutputView");
      let html = "<h3>활동 결과</h3>";

      let totalAnswers = [];

      activityData.activities.forEach((act, idx) => {
        if (idx > 0) {
          html += `<div style="margin: 1rem 0;"></div>`;
        }
        html += `<h4>${act.type}</h4>`;

        // 단어 및 주요 표현 익히기
        if (act.type === "단어 및 주요 표현 익히기" && act.items) {
          act.items.forEach((item, i) => {
            // item => { vocab, meaning, answer? }
            const lineLen = 80; // 가로 끝까지
            let line = "";
            for(let k=0; k<lineLen; k++){ line+="_"; }
            html += `
              <p style="margin-bottom:10px;">
                ${i+1}) <strong>${item.vocab}</strong>: ${item.meaning}
                <br/>${line}
              </p>
            `;
          });
        }
        // 영어 문장 해석하기
        else if (act.type === "영어 문장 해석하기" && act.sentences) {
          act.sentences.forEach((s, i) => {
            // s => { original, answer?}
            const len = Math.round(s.original.length*1.2);
            let line = "";
            for(let k=0;k<len;k++){ line+="_"; }
            html += `
              <p style="margin-bottom:10px;">
                ${i+1}) ${s.original}
                <br/>해석: ${line}
              </p>
            `;
            if (s.answer) {
              if (showAnswers) {
                html += `<p style="color:blue;">[정답] ${s.answer}</p>`;
              } else {
                totalAnswers.push(`[영문해석 ${i+1}] ${s.answer}`);
              }
            }
          });
        }
        // 빈 칸 채우기
        else if (act.type === "빈 칸 채우기" && act.questions) {
          act.questions.forEach((qItem, i) => {
            // qItem => { sentence, solution? }
            html += `
              <p style="margin-bottom:10px;">
                ${i+1}) ${qItem.sentence}
              </p>
            `;
            if(qItem.solution) {
              if(showAnswers) {
                html += `<p style="color:blue;">[정답] ${qItem.solution}</p>`;
              } else {
                totalAnswers.push(`[빈칸 ${i+1}] ${qItem.solution}`);
              }
            }
          });
        }
        // 우리말 영어로 번역하기
        else if (act.type === "우리말 영어로 번역하기" && act.list) {
          act.list.forEach((row, i) => {
            // row => {korean, answer?}
            const len = Math.round(row.korean.length*1.2);
            let line = "";
            for(let k=0;k<len;k++){ line+="_"; }
            html += `
              <p style="margin-bottom:10px;">
                ${i+1}) ${row.korean}
                <br/>영어: ${line}
              </p>
            `;
            if (row.answer) {
              if (showAnswers) {
                html += `<p style="color:blue;">[정답] ${row.answer}</p>`;
              } else {
                totalAnswers.push(`[한->영 ${i+1}] ${row.answer}`);
              }
            }
          });
        }
        // 문법 변형 활동
        else if (act.type === "문법 변형 활동" && act.examples) {
          act.examples.forEach((ex, i) => {
            // ex => { instruction, original, answer?}
            const len = Math.round(ex.original.length*1.2);
            let line="";
            for(let k=0;k<len;k++){ line+="_"; }
            html += `
              <p style="margin-bottom:10px;">
                ${i+1}) [${ex.instruction}]<br/>
                원문: ${ex.original}
                <br/>변형: ${line}
              </p>
            `;
            if(ex.answer) {
              if(showAnswers) {
                html += `<p style="color:blue;">[정답] ${ex.answer}</p>`;
              } else {
                totalAnswers.push(`[문법변형 ${i+1}] ${ex.answer}`);
              }
            }
          });
        }
        else {
          html += `<p>해당 활동에 대한 데이터가 없습니다.</p>`;
        }
      });

      // 만약 showAnswers=false
      if(!showAnswers){
        html += `
          <div style="margin-top:20px;">
            <button onclick="showActivityAnswers()">
              <i class="fas fa-eye"></i> 정답
            </button>
            <button onclick="printPage()">
              <i class="fas fa-print"></i> 웹 페이지 인쇄
            </button>
          </div>
        `;
      }
      else {
        // showAnswers=true
        html += `
          <div style="margin-top:20px;">
            <button onclick="printPage()">
              <i class="fas fa-print"></i> 웹 페이지 인쇄
            </button>
          </div>
        `;
